<root BTCPP_format="4">
    <BehaviorTree ID="MainTree">
        <Sequence>
            <!-- Manipulation Task Arguments -->
            <Script code="device_type:='needle_valve'" />
            <Script code="direction:=-1" />
            <Script code="device_id:='0'" />
            <Script code="manipulation_todo:=1.5707" />
            <Script code="strategy:=0" />

            <!-- LookupDevicePose -->

            <!-- Get Pose of (Unrotated) Handle -->
            <Script code="source_frame:=device_type + '/' + device_id + '/handle'" />

            <!-- Note - Link Offset Translation is used to Align Realsense with Device Centre -->
            <!-- <GetTFTransformAsPose source_frame="{source_frame}" target_frame="world" pose="{handle_pose}" link_offset_translation="0 0.06 0" link_offset_rotation="0 0 0 1"/> -->
            <GetTFTransformAsPose source_frame="{source_frame}" target_frame="world" pose="{handle_pose}" link_offset_translation="0 0 0" link_offset_rotation="0 0 0 1"/>

            <!-- Approach -->

            <!-- Open Gripper -->
            <SaySomething message="Opening Gripper" />
            <UnitreeGripperCommand name="openGripper" command="open" />

            <!-- Tick approachTarget Action-->
            <SaySomething message="Moving to Pre-Grasp Pose..." />
            <approachTargetNode target="{handle_pose}"/>


            <Precondition if="device_type == 'button'" else="SUCCESS">
                <Sequence>
                    <!-- Get Pose of (Rotated) Handle -->
                    <Script code="source_frame:=device_type + '/' + device_id + '/handle'" />
                    <GetTFTransformAsPose source_frame="{source_frame}" target_frame="world" pose="{handle_pose}" link_offset_translation="0 0 0" link_offset_rotation="0 0 0 1"/>

                    <!-- Tick approachTarget Action-->
                    <SaySomething message="Moving to Adjusted Pre-Grasp Pose..." />
                    <approachTargetNode target="{handle_pose}"/>
                </Sequence>
            </Precondition>


            <!-- Grasp -->

            <!-- Tick graspTarget Action-->
            <SaySomething message="Moving to Grasp Pose..." />
            <graspTargetNode target="{handle_pose}" device_type="{device_type}" strategy="{strategy}" direction="{direction}"/>

            <!-- Close Gripper -->
            <SaySomething message="Closing Gripper" />
            <UnitreeGripperCommand name="closeGripper" command="close" />


        </Sequence>
    </BehaviorTree>
</root>
