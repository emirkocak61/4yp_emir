<?xml version="1.0"?>
<root main_tree_to_execute="MainTree" BTCPP_format="4">



    <BehaviorTree ID="MainTree">

        <Sequence>

            <!-- Manipulation Task Arguments -->
            <Script code="device_type:='needle_valve'" />
            <Script code="device_id:='0'" />
            <Script code="floor:=false" />

            <!-- Set Home -->
            <SubTree ID="SetWaypointAsCurrentBasePose" waypoint="{home}" />

            <!-- Navigate to Device -->
            <SubTree ID="NavigateToDevice" device_type="{device_type}" device_id="{device_id}" floor="{floor}"/>

            <SleepNode msec="2000" />

            <!-- Return to Home -->
            <SubTree ID="NavigateToWaypoint" waypoint="{home}" />

        </Sequence>

    </BehaviorTree>



    <BehaviorTree ID="SetWaypointAsCurrentBasePose">
        <SequenceWithMemory>
            <GetTFTransformAsPose source_frame="base" target_frame="odom" pose="{waypoint}"/>
        </SequenceWithMemory>
    </BehaviorTree>



    <BehaviorTree ID="NavigateToWaypoint">
        <SequenceWithMemory>
            <!-- <GoToMotionStateAnymal goal_motion_state="perceptive_walk"/> -->
            <GoToMotionStateAnymal goal_motion_state="walk"/>

            <!-- NB: walking in dynamic gaits mode causes a crash on hardware -->
            <!-- <SwitchControllerAndSetOperationModeAnymal motion_controller="dynamic_gaits" reference_type="2" operation_mode="walk"/> -->
            <NavigateToGoalAnymal target="{waypoint}"/>
            <GoToMotionStateAnymal goal_motion_state="square_up"/>
            <GoToMotionStateAnymal goal_motion_state="stand"/>
            <SleepNode msec="5000" />
            <GoToMotionStateAnymal goal_motion_state="torso_control"/>
            <SleepNode msec="2500" />
        </SequenceWithMemory>
    </BehaviorTree>



    <BehaviorTree ID="NavigateToDevice">
        <SequenceWithMemory>

            <Script code="target_device:=device_type + '/' + device_id + '/waypoint'"/>

            <GetTFTransformAsPose source_frame="{target_device}" target_frame="odom" pose="{target}" link_offset_translation="0 0 0" link_offset_rotation="-0.5 0.5 0.5 0.5"/>

            <!-- <GoToMotionStateAnymal goal_motion_state="perceptive_walk"/> -->
            <GoToMotionStateAnymal goal_motion_state="walk"/>

            <!-- NB: walking in dynamic gaits mode causes a crash on hardware -->
            <!-- <SwitchControllerAndSetOperationModeAnymal motion_controller="dynamic_gaits" reference_type="2" operation_mode="walk"/> -->
            <NavigateToGoalAnymal target="{target}"/>
            <GoToMotionStateAnymal goal_motion_state="square_up"/>
            <GoToMotionStateAnymal goal_motion_state="stand"/>
            <SleepNode msec="5000" />
            <GoToMotionStateAnymal goal_motion_state="torso_control"/>
            <SleepNode msec="2500" />

        </SequenceWithMemory>
    </BehaviorTree>

</root>
